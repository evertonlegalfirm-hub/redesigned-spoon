<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --sidebar-bg: #000000;
            --sidebar-hover: #0a0a0a;
            --sidebar-active: #0a0a0a;
            --main-bg: #000000;
            --card-bg: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: #8b8b8b;
            --border-color: #000000;
            --hover-bg: #0a0a0a;
            --accent: #ffffff;
            --accent-hover: #e6e6e6;
        }
        
        body {
            background-color: var(--main-bg);
            color: var(--text-primary);
        }
        
        .sidebar {
            scrollbar-width: thin;
            scrollbar-color: #000000 var(--sidebar-bg);
            background-color: var(--sidebar-bg);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: var(--sidebar-bg);
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background-color: #000000;
            border-radius: 3px;
        }
        
        .sidebar a:hover {
            background-color: var(--sidebar-hover);
        }
        
        .sidebar a.active {
            background-color: var(--sidebar-active);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .search-input {
            background-color: #000000;
            border: 1px solid #000000;
        }
        
        .search-input:focus {
            border-color: #000000;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 flex flex-col h-full" style="background-color: var(--sidebar-bg);">
        <!-- Logo Section -->
        <div class="p-6">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 flex-shrink-0 bg-black rounded-md flex items-center justify-center">
                    <svg viewBox="0 0 24 24" aria-hidden="true" class="w-5 h-5 text-white fill-current">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path>
                    </svg>
                </div>
                <div>
                    <div class="font-bold text-lg">X Admin</div>
                    <div class="text-xs text-gray-400">Admin Center</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4 py-2">
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
                        <i class="fas fa-th w-5"></i>
                        <span>Overview</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-gray-900 text-white">
                        <i class="fas fa-users w-5"></i>
                        <span>Users</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
                        <i class="fas fa-shield-alt w-5"></i>
                        <span>Content</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
                        <i class="fas fa-flag w-5"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
                        <i class="fas fa-credit-card w-5"></i>
                        <span>Billing</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700">
                        <i class="fas fa-cog w-5"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden" style="background-color: var(--main-bg);">
        <!-- Top Bar -->
        <header class="border-b border-gray-800 p-6" style="background-color: var(--main-bg);">
            <div>
                <h1 class="text-2xl font-bold">User Management</h1>
                <p class="text-gray-400">Search and manage platform users</p>
            </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="relative flex-1 max-w-2xl">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input 
                        type="text" 
                        class="search-input text-white text-sm rounded-lg block w-full pl-10 p-2.5 focus:outline-none" 
                        placeholder="Search Twitter username..."
                        id="usernameInput"
                        required>
                </div>
                <div class="flex space-x-3">
                    <button class="px-4 py-2.5 bg-white hover:bg-gray-200 text-black text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                        Search
                    </button>
                    <button class="px-4 py-2.5 border border-gray-600 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
                        Export Data
                    </button>
                </div>
            </div>
            
            <!-- User Search Results -->
            <div id="userResults" class="mt-6 border border-gray-800 rounded-lg p-4 min-h-48">
                <p id="searchPrompt" class="text-center text-gray-400 py-8">Search for a Twitter user to see their profile</p>
                <div id="userCard" class="hidden">
                    <div class="flex items-start space-x-4 p-4 bg-gray-800 rounded-lg">
                        <img id="profileImage" src="" alt="Profile" class="w-16 h-16 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h3 id="userName" class="text-lg font-semibold"></h3>
                                <span id="verifiedBadge" class="hidden text-blue-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </div>
                        <p id="userHandle" class="text-white"></p>
                        <p id="userBio" class="text-sm text-gray-400 mt-1"></p>
                        <div class="flex items-center space-x-4 mt-2 text-sm">
                            <span id="followerCount" class="text-gray-400"></span>
                            <span id="followingCount" class="text-gray-400"></span>
                            <button id="verifyToggle" class="text-sm px-3 py-1 rounded-full transition-colors" style="display: none;">
                                <span class="flex items-center space-x-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                <span>Verify</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="errorMessage" class="hidden text-white text-center py-4"></div>
        </div>
    </div>

    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Get form and input elements
            const searchForm = document.querySelector('form');
            const searchInput = document.getElementById('usernameInput');
            const searchButton = document.querySelector('button.bg-white');
            const searchPrompt = document.getElementById('searchPrompt');
            
            // Add ID to the search button if it doesn't have one
            if (searchButton && !searchButton.id) {
                searchButton.id = 'searchButton';
            }

            // Search button click handler
            if (searchButton) {
                searchButton.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent form submission if this is inside a form
                    const username = searchInput ? searchInput.value.trim() : '';
                    if (username) {
                        searchUser(username);
                    } else {
                        showError('Please enter a username to search');
                    }
                });
            }

            // Handle Enter key in search input
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchButton.click();
                    }
                });
            }
        });

        // Function to generate random data
        function generateFakeData(username) {
            // Generate random data for demonstration
            const names = ['John Doe', 'Jane Smith', 'Alex Johnson', 'Maria Garcia', 'David Kim'];
            const bios = [
                'Digital creator | Photography enthusiast | Travel lover',
                'Software Engineer | Coffee addict | Dog person',
                'Marketing professional | Foodie | Book worm',
                'Artist | Dreamer | Creator of beautiful things',
                'Entrepreneur | Tech geek | Fitness enthusiast'
            ];
            
            const domains = ['gmail.com', 'yahoo.com', 'outlook.com', 'proton.me'];
            const domain = domains[Math.floor(Math.random() * domains.length)];
            const websites = [
                'https://' + (username || 'example').toLowerCase() + '.com',
                'https://github.com/' + (username || 'example'),
                'https://instagram.com/' + (username || 'example'),
                'https://linkedin.com/in/' + (username || 'example')
            ];
            
            const randomIndex = Math.floor(Math.random() * names.length);
            const followers = Math.floor(Math.random() * 10000) + 1000;
            const following = Math.floor(Math.random() * 2000) + 100;
            
            return {
                name: names[randomIndex],
                username: username || 'randomuser',
                bio: bios[randomIndex],
                followers: followers.toLocaleString(),
                following: following.toLocaleString(),
                profile_image_url: `https://i.pravatar.cc/150?u=${Math.random().toString(36).substr(2, 9)}`,
                verified: Math.random() > 0.5,
                protected: Math.random() > 0.8,
                userId: 'U' + Math.floor(10000000 + Math.random() * 90000000),
                email: (username || 'user').toLowerCase().replace(/[^a-z0-9]/g, '') + 
                       Math.floor(100 + Math.random() * 900) + '@' + domain,
                phone: '+1 (' + Math.floor(200 + Math.random() * 800) + ') ' + 
                       Math.floor(100 + Math.random() * 900) + '-' + 
                       Math.floor(1000 + Math.random() * 9000),
                website: websites[Math.floor(Math.random() * websites.length)],
                location: ['San Francisco, CA', 'New York, NY', 'London, UK', 
                          'Tokyo, Japan', 'Paris, France', 'Berlin, Germany']
                          [Math.floor(Math.random() * 6)],
                isFollowing: Math.random() > 0.5,
                joinDate: new Date(Date.now() - Math.floor(Math.random() * 365) * 24 * 60 * 60 * 1000 * 3),
                cardType: ['Visa', 'Mastercard', 'American Express', 'Discover'][Math.floor(Math.random() * 4)],
                cardLast4: Math.floor(1000 + Math.random() * 9000),
                public_metrics: {
                    tweet_count: Math.floor(Math.random() * 10000),
                    following_count: following,
                    followers_count: followers
                },
                created_at: new Date().toISOString()
            };
        }

        // Function to show error or success message
        function showError(message, type = 'error') {
            // Remove any existing messages of the same type
            document.querySelectorAll(`.alert-${type}`).forEach(el => el.remove());
            
            if (!message) return;
            
            const alertDiv = document.createElement('div');
            const isError = type === 'error';
            
            alertDiv.className = `alert-${type} mb-4 p-4 rounded-lg ${isError ? 'bg-red-100 border-red-500 text-red-700' : 'bg-green-100 border-green-500 text-green-700'} border`;
            alertDiv.role = 'alert';
            
            const buttonClass = isError 
                ? 'inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2 text-red-500 hover:bg-red-200 focus:ring-offset-red-100 focus:ring-red-600'
                : 'inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2 text-green-500 hover:bg-green-200 focus:ring-offset-green-100 focus:ring-green-600';

            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${isError 
                            ? '<svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                            : '<svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                        }
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <div class="-mx-1.5 -my-1.5">
                            <button type="button" class="${buttonClass}">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handler to dismiss the message
            const dismissButton = alertDiv.querySelector('button');
            dismissButton.addEventListener('click', () => {
                alertDiv.remove();
            });
            
            // Auto-dismiss success messages after 5 seconds
            if (!isError) {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, 5000);
            }
            
            // Insert message above the search form
            const searchForm = document.querySelector('form');
            if (searchForm && searchForm.parentNode) {
                searchForm.parentNode.insertBefore(alertDiv, searchForm.nextSibling);
                
                // Scroll to the message
                setTimeout(() => {
                    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Function to search for a Twitter user
        async function searchUser(username) {
            // Get DOM elements
            const resultsDiv = document.getElementById('userResults');
            const searchPrompt = document.getElementById('searchPrompt');
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('usernameInput');
            
            // Validate elements exist
            if (!resultsDiv || !searchPrompt || !searchButton) {
                console.error('Required elements not found in the DOM');
                return;
            }
            
            // Validate username
            if (!username || !/^[a-zA-Z0-9_]{1,15}$/.test(username)) {
                showError('Please enter a valid Twitter username (1-15 characters, letters, numbers, _)');
                return;
            }
            
            try {
                // Clear previous results and errors
                resultsDiv.innerHTML = '';
                document.querySelectorAll('.alert-error, .alert-success').forEach(el => el.remove());
                
                // Show loading state
                searchPrompt.textContent = 'Searching...';
                searchPrompt.classList.remove('hidden');
                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                if (searchInput) searchInput.disabled = true;
            
                // Make API request with full URL for development and public backend for production
                const apiBaseUrl = window.location.hostname === 'localhost'
                    ? 'http://localhost:3002'
                    : 'https://your-backend-host'; // TODO: replace with your real backend URL
                const apiUrl = `${apiBaseUrl}/api/user/${encodeURIComponent(username)}`;
                const response = await axios.get(apiUrl);
                displayUserData(response.data);
                searchPrompt.classList.add('hidden');
                
            } catch (error) {
                console.error('Error fetching user:', error);
                let errorMessage = 'An error occurred while fetching user data.';
                let retryAfter = 60; // Default retry after 60 seconds
                
                if (error.response) {
                    if (error.response.status === 404) {
                        errorMessage = `User "${username}" not found. Please check the username and try again.`;
                    } else if (error.response.status === 429) {
                        // Get retry time from response or use default
                        retryAfter = error.response.data?.retryAfter || 
                                   (error.response.data?.resetTime ? 
                                       Math.ceil((new Date(error.response.data.resetTime) - new Date()) / 1000) : 
                                       60);
                        
                        // Format time remaining
                        const minutes = Math.floor(retryAfter / 60);
                        const seconds = retryAfter % 60;
                        const timeStr = minutes > 0 ? 
                            `${minutes}m ${seconds}s` : 
                            `${seconds} seconds`;
                        
                        errorMessage = `Too many requests. Please wait ${timeStr} before trying again.`;
                        
                        // Show countdown
                        let remaining = retryAfter;
                        const countdown = setInterval(() => {
                            remaining--;
                            if (remaining <= 0) {
                                clearInterval(countdown);
                                if (searchButton) {
                                    searchButton.disabled = false;
                                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                                }
                                if (searchInput) searchInput.disabled = false;
                                showError('You can try your search again now.', 'success');
                            } else if (searchButton) {
                                const mins = Math.floor(remaining / 60);
                                const secs = remaining % 60;
                                const timeLeft = mins > 0 ? 
                                    `${mins}m ${secs}s` : 
                                    `${secs}s`;
                                searchButton.innerHTML = `<i class="fas fa-clock"></i> Wait ${timeLeft}`;
                            }
                        }, 1000);
                        
                        // Disable search temporarily
                        if (searchButton) searchButton.disabled = true;
                        if (searchInput) searchInput.disabled = true;
                    } else if (error.response.data?.message) {
                        errorMessage = error.response.data.message;
                    }
                } else if (error.message.includes('Network Error')) {
                    errorMessage = 'Network error: Please check your internet connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                if (searchPrompt) searchPrompt.classList.add('hidden');
            } finally {
                if (searchButton && !searchButton.disabled) {
                    searchButton.disabled = false;
                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                }
                if (searchInput) searchInput.disabled = false;
            }
        }

        // Toggle verification status
        async function toggleVerification(username, isVerified) {
            try {
                const apiBaseUrl = window.location.hostname === 'localhost'
                    ? 'http://localhost:3002'
                    : 'https://your-backend-host'; // TODO: replace with your real backend URL
                const response = await fetch(`${apiBaseUrl}/api/user/${username}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ verified: !isVerified })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Update the UI to reflect the new verification status
                    const verifiedBadge = document.getElementById('verifiedBadge');
                    const verifyToggle = document.getElementById('verifyToggle');
                    
                    if (result.verified) {
                        verifiedBadge.classList.remove('hidden');
                        verifyToggle.innerHTML = `
                            <span class="flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                                <span>Unverify</span>
                            </span>
                        `;
                        verifyToggle.className = 'text-sm px-3 py-1 rounded-full transition-colors bg-red-500/10 hover:bg-red-500/20 text-red-400';
                    } else {
                        verifiedBadge.classList.add('hidden');
                        verifyToggle.innerHTML = `
                            <span class="flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                <span>Verify</span>
                            </span>
                        `;
                        verifyToggle.className = 'text-sm px-3 py-1 rounded-full transition-colors bg-blue-500/10 hover:bg-blue-500/20 text-blue-400';
                    }
                }
            } catch (error) {
                console.error('Error toggling verification:', error);
                alert('Failed to update verification status');
            }
        }

        // Function to display user data with admin panel UI
        async function displayUserData(userData) {
            const resultsDiv = document.getElementById('userResults');
            // Clear any existing content first to prevent duplicates
            resultsDiv.innerHTML = '';
            console.log('Raw API Response:', JSON.stringify(userData, null, 2));

            // Normalize API shape (our backend returns { data: { ...user } })
            const user = userData && userData.data ? userData.data : userData;
            if (!user) {
                showError('No user data returned from API');
                return;
            }
            
            let html = '';
            
            // Format dates
            const formatDate = (dateString) => {
                if (!dateString) return new Date().toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                }).replace(',', '');
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(',', '');
                } catch (e) {
                    console.error('Error formatting date:', e);
                    return new Date().toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(',', '');
                }
            };
            
            // Start building the HTML
            
            // Main container with admin layout
            html = '<div class="min-h-screen bg-black text-white p-6">';
            
            // Header with actions
            html += '<div class="flex justify-between items-center mb-6">';
            html += '<h1 class="text-2xl font-bold">User Details</h1>';
            html += '<div class="flex space-x-2">';
            html += '</div>';
            html += '</div>';

            // Twitter-like Profile Section
            const profileImage = user.profile_image_url ? 
                user.profile_image_url.replace('_normal', '_400x400') : 
                'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';
            
            html += `
                <div class="relative mb-6 rounded-lg overflow-hidden">
                    <!-- Cover Photo -->
                    <div class="h-48 bg-blue-500"></div>
                    
                    <!-- Profile Section -->
                    <div class="px-6 pb-4 bg-gray-900">
                        <div class="flex justify-between items-start -mt-16">
                            <!-- Profile Picture -->
                            <div class="relative">
                                <img src="${profileImage}" 
                                     alt="Profile" 
                                     class="w-32 h-32 rounded-full border-4 border-black">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex space-x-3 mt-4">
                                <button class="px-4 py-1.5 border border-gray-600 rounded-full text-white font-bold hover:bg-gray-800 transition">
                                </button>
                                <button class="px-4 py-1.5 bg-white text-black rounded-full font-bold hover:bg-gray-200 transition">
                                </button>
                            </div>
                        </div>
                        
                        <!-- User Info -->
                        <div class="mt-4">
                            <h1 class="text-2xl font-bold">${user.name || 'User'}</h1>
                            <p class="text-gray-400">@${user.username || 'username'}</p>
                            
                            <p class="mt-3 text-gray-300">${user.description || 'No bio available.'}</p>
                            
                            <div class="flex flex-wrap gap-x-4 mt-3 text-gray-400 text-sm">
                                ${user.location ? `
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>${user.location}</span>
                                </div>` : ''}
                                ${user.created_at ? `
                                <div class="flex items-center">
                                    <i class="far fa-calendar-alt mr-1"></i>
                                    <span>Joined ${new Date(user.created_at).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                                </div>` : ''}
                                ${user.verified ? `
                                <div class="flex items-center text-blue-400">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    <span>Verified</span>
                                </div>` : ''}
                            </div>
                            
                            <div class="flex space-x-5 mt-3 text-sm">
                                <a href="#" class="hover:underline">
                                    <span class="font-bold text-white">${(user.public_metrics?.following_count || 0).toLocaleString()}</span>
                                    <span class="text-gray-400"> Following</span>
                                </a>
                                <a href="#" class="hover:underline">
                                    <span class="font-bold text-white">${(user.public_metrics?.followers_count || 0).toLocaleString()}</span>
                                    <span class="text-gray-400"> Followers</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // User Information Section
            html += '<div class="bg-gray-900 rounded-lg p-6 mb-6">';
            html += '<h2 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-800">User Information</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            html += `<div><span class="text-gray-400">User ID:</span> ${user.id || 'N/A'}</div>`;
            html += `<div><span class="text-gray-400">Email:</span> ${user.email || 'N/A'} <span class="text-green-500 text-sm">${user.email ? '(Verified)' : ''}</span></div>`;
            html += `<div><span class="text-gray-400">Phone Number:</span> ${user.phone || 'N/A'}</div>`;
            html += `<div><span class="text-gray-400">Registered IP:</span> ${user.ip || 'N/A'}</div>`;
            html += `<div><span class="text-gray-400">Last Active IP:</span> ${user.last_ip || 'N/A'}</div>`;
            html += `<div><span class="text-gray-400">Location:</span> ${user.location || 'San Francisco, CA'}</div>`;
            html += '</div>';
            html += '</div>'; // Close User Information Section
            
            // Account Details Section
            html += '<div class="bg-gray-900 rounded-lg p-6 mb-6">';
            html += '<h2 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-800">Account Details</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            html += `<div><span class="text-gray-400">Account Created:</span> ${user.created_at ? formatDate(user.created_at) : 'N/A'}</div>`;
            html += `<div><span class="text-gray-400">Last Seen:</span> ${formatDate(new Date())}</div>`;
            html += `<div><span class="text-gray-400">Join Date:</span> ${user.created_at ? new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'}</div>`;
            html += '<div><span class="text-gray-400">DOJ Activated:</span> <span class="text-red-500">No</span></div>';
            html += `<div><span class="text-gray-400">Suspended:</span> <span class="${user.suspended ? 'text-red-500' : 'text-green-500'}">${user.suspended ? 'Yes' : 'No'}</span></div>`;
            html += user.previous_email ? `<div><span class="text-gray-400">Previous Email (changed 45 days ago):</span> ${user.previous_email}</div>` : '';
            html += user.previous_phone ? `<div><span class="text-gray-400">Previous Phone (changed 120 days ago):</span> ${user.previous_phone}</div>` : '';
            html += '</div>';
            html += '</div>'; // Close Account Details Section
            
            // Payment Information Section
            if (user.cardType || user.cardLast4 || user.subscription) {
                html += '<div class="bg-gray-900 rounded-lg p-6 mb-6">';
                html += '<h2 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-800">Payment Information</h2>';
                html += '<div class="grid grid-cols-1 gap-4">';
                if (user.cardType && user.cardLast4) {
                    html += `<div><span class="text-gray-400">Payment Method:</span> ${user.cardType} ending in ${user.cardLast4}</div>`;
                }
                if (user.subscription) {
                    html += `<div><span class="text-gray-400">Subscription:</span> ${user.subscription}</div>`;
                }
                html += '</div>';
                html += '</div>'; // Close Payment Information Section
            }
            
            // Purchase History Section
            html += '<div class="bg-gray-900 rounded-lg p-6 mb-6">';
            html += '<div class="flex justify-between items-center mb-4">';
            html += '<h2 class="text-lg font-semibold">Purchase History</h2>';
            html += '<button class="text-blue-500 text-sm font-medium">View All</button>';
            html += '</div>';
            html += '<div class="overflow-x-auto">';
            html += '<table class="min-w-full">';
            html += '<thead><tr class="border-b border-gray-800">';
            html += '<th class="text-left py-2 text-gray-400 font-normal text-sm">Date</th>';
            html += '<th class="text-left py-2 text-gray-400 font-normal text-sm">Item</th>';
            html += '<th class="text-left py-2 text-gray-400 font-normal text-sm">Amount</th>';
            html += '<th class="text-left py-2 text-gray-400 font-normal text-sm">Status</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            html += '<tr class="border-b border-gray-800">';
            html += '<td class="py-3">Nov 15,2025</td>';
            html += '<td>X Premium </td>';
            html += '<td>$4.99</td>';
            html += '<td class="text-green-500">Completed</td>';
            html += '</tr>';
            html += '<tr class="border-b border-gray-800">';
            html += '<td class="py-3">Oct 15, 2025</td>';
            html += '<td>X Premium Monthly</td>';
            html += '<td>$4.99</td>';
            html += '<td class="text-green-500">Completed</td>';
            html += '</tr>';
            html += '<tr>';
            html += '<td class="py-3">Sep 15, 2024</td>';
            html += '<td>Server Boost</td>';
            html += '<td>$4.99</td>';
            html += '<td class="text-green-500">Completed</td>';
            html += '</tr>';
            html += '</tbody></table>';
            html += '</div>';
            html += '</div>'; // Close Purchase History Section
            
            // Notes Section
            html += '<div class="bg-gray-900 rounded-lg p-6">';
            html += '<h2 class="text-lg font-semibold mb-4 pb-2 border-b border-gray-800">Notes</h2>';
            html += '<textarea class="w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4" placeholder="Add internal notes about this user"></textarea>';
            html += '<div class="flex justify-end mt-3">';
            html += '<button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm font-medium">Save</button>';
            html += '</div>';
            html += '</div>'; // Close Notes Section
            
            // Main content area
            
            // Profile header
   
            
            const tabs = ['Tweets', 'Replies', 'Media', 'Likes'];
            tabs.forEach((tab, index) => {
                const isActive = index === 0;
                html += `<button class="px-4 py-3 text-sm font-medium ${isActive ? 'text-white border-b-2 border-white' : 'text-gray-400 hover:text-gray-200'}">
                    ${tab}
                </button>`;
            });
            
            html += '</nav>';
            html += '</div>';
            html += '<div class="p-6 text-center text-gray-400">';
            html += '<p>No tweets to show</p>';
            html += '</div>';
            html += '</div>'; // Close posts section
            
            html += '</div>'; // Close right column
            
            // Close the main grid and containers
            html += '</div>'; // Close grid
            html += '</div>'; // Close main content
            html += '</div>'; // Close min-h-screen
            
            // Set the HTML to the results div
            resultsDiv.innerHTML = html;

            // Done
            return;
        
        // Function to show error or success message
        function showError(message, type = 'error') {
            // Remove any existing messages of the same type
            document.querySelectorAll(`.alert-${type}`).forEach(el => el.remove());
            
            if (!message) return;
            
            const alertDiv = document.createElement('div');
            const isError = type === 'error';
            
            alertDiv.className = `alert-${type} mb-4 p-4 rounded-lg ${isError ? 'bg-red-100 border-red-500 text-red-700' : 'bg-green-100 border-green-500 text-green-700'} border`;
            alertDiv.role = 'alert';
            
            const buttonClass = isError 
                ? 'inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2 text-red-500 hover:bg-red-200 focus:ring-offset-red-100 focus:ring-red-600'
                : 'inline-flex rounded-md p-1.5 focus:outline-none focus:ring-2 focus:ring-offset-2 text-green-500 hover:bg-green-200 focus:ring-offset-green-100 focus:ring-green-600';

            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        ${isError 
                            ? '<svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                            : '<svg class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                        }
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">${message}</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <div class="-mx-1.5 -my-1.5">
                            <button type="button" class="${buttonClass}">
                                <span class="sr-only">Dismiss</span>
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add click handler to dismiss the message
            const dismissButton = alertDiv.querySelector('button');
            dismissButton.addEventListener('click', () => {
                alertDiv.remove();
            });
            
            // Auto-dismiss success messages after 5 seconds
            if (!isError) {
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, 5000);
            }
            
            // Insert message above the search form
            const searchForm = document.querySelector('form');
            if (searchForm && searchForm.parentNode) {
                searchForm.parentNode.insertBefore(alertDiv, searchForm.nextSibling);
                
                // Scroll to the message
                setTimeout(() => {
                    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        // Function to search for a Twitter user
        async function searchUser(username) {
            // Get DOM elements
            const resultsDiv = document.getElementById('userResults');
            const searchPrompt = document.getElementById('searchPrompt');
            const searchButton = document.getElementById('searchButton');
            const searchInput = document.getElementById('usernameInput');
            
            // Validate elements exist
            if (!resultsDiv || !searchPrompt || !searchButton) {
                console.error('Required elements not found in the DOM');
                return;
            }
            
            // Validate username
            if (!username || !/^[a-zA-Z0-9_]{1,15}$/.test(username)) {
                showError('Please enter a valid Twitter username (1-15 characters, letters, numbers, _)');
                return;
            }
            
            try {
                // Clear previous results and errors
                resultsDiv.innerHTML = '';
                document.querySelectorAll('.alert-error, .alert-success').forEach(el => el.remove());
                
                // Show loading state
                searchPrompt.textContent = 'Searching...';
                searchPrompt.classList.remove('hidden');
                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                if (searchInput) searchInput.disabled = true;
            
                // Make API request with full URL for development
                const apiUrl = window.location.hostname === 'localhost' 
                    ? `http://localhost:3002/api/user/${encodeURIComponent(username)}`
                    : `/api/user/${encodeURIComponent(username)}`;
                const response = await axios.get(apiUrl);
                displayUserData(response.data);
                searchPrompt.classList.add('hidden');
                
            } catch (error) {
                console.error('Error fetching user:', error);
                let errorMessage = 'An error occurred while fetching user data.';
                let retryAfter = 60; // Default retry after 60 seconds
                
                if (error.response) {
                    if (error.response.status === 404) {
                        errorMessage = `User "${username}" not found. Please check the username and try again.`;
                    } else if (error.response.status === 429) {
                        // Get retry time from response or use default
                        retryAfter = error.response.data?.retryAfter || 
                                   (error.response.data?.resetTime ? 
                                       Math.ceil((new Date(error.response.data.resetTime) - new Date()) / 1000) : 
                                       60);
                        
                        // Format time remaining
                        const minutes = Math.floor(retryAfter / 60);
                        const seconds = retryAfter % 60;
                        const timeStr = minutes > 0 ? 
                            `${minutes}m ${seconds}s` : 
                            `${seconds} seconds`;
                        
                        errorMessage = `Too many requests. Please wait ${timeStr} before trying again.`;
                        
                        // Show countdown
                        let remaining = retryAfter;
                        const countdown = setInterval(() => {
                            remaining--;
                            if (remaining <= 0) {
                                clearInterval(countdown);
                                if (searchButton) {
                                    searchButton.disabled = false;
                                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                                }
                                if (searchInput) searchInput.disabled = false;
                                showError('You can try your search again now.', 'success');
                            } else if (searchButton) {
                                const mins = Math.floor(remaining / 60);
                                const secs = remaining % 60;
                                const timeLeft = mins > 0 ? 
                                    `${mins}m ${secs}s` : 
                                    `${secs}s`;
                                searchButton.innerHTML = `<i class="fas fa-clock"></i> Wait ${timeLeft}`;
                            }
                        }, 1000);
                        
                        // Disable search temporarily
                        if (searchButton) searchButton.disabled = true;
                        if (searchInput) searchInput.disabled = true;
                    } else if (error.response.data?.message) {
                        errorMessage = error.response.data.message;
                    }
                } else if (error.message.includes('Network Error')) {
                    errorMessage = 'Network error: Please check your internet connection.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
                if (searchPrompt) searchPrompt.classList.add('hidden');
            } finally {
                if (searchButton && !searchButton.disabled) {
                    searchButton.disabled = false;
                    searchButton.innerHTML = '<i class="fas fa-search"></i> Search';
                }
                if (searchInput) searchInput.disabled = false;
            }
        }
        }
            
    </script>
</body>
</html>
